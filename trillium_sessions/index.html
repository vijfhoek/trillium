<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Trillium sessions"><meta name="keywords" content="rust, rustlang, rust-lang, trillium_sessions"><title>trillium_sessions - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script id="default-settings" ></script><script src="../storage.js"></script><script src="../crates.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../favicon.svg"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod crate"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../trillium_sessions/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><h2 class="location">Crate trillium_sessions</h2><div class="block version"><div class="narrow-helper"></div><p>Version 0.2.0</p></div><div class="sidebar-elems"><a id="all-types" href="all.html"><p>See all trillium_sessions's items</p></a><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#traits">Traits</a></li></ul></div><div id="sidebar-vars" data-name="trillium_sessions" data-ty="mod" data-relpath=""></div><script defer src="sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="18" height="18" alt="Pick another theme!" src="../brush.svg"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../settings.html" title="settings"><img width="18" height="18" alt="Change settings" src="../wheel.svg"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="#">trillium_sessions</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/trillium_sessions/lib.rs.html#1-122" title="goto source code">[src]</a></span></h1><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><h1 id="trillium-sessions" class="section-header"><a href="#trillium-sessions">Trillium sessions</a></h1>
<p>Trillium sessions is built on top of
<a href="https://github.com/http-rs/async-session"><code>async-session</code></a>.</p>
<p>Sessions allows trillium to securely attach data to a browser session
allowing for retrieval and modification of this data within trillium
on subsequent visits. Session data is generally only retained for the
duration of a browser session.</p>
<p>Trillium’s session implementation provides guest sessions by default,
meaning that all web requests to a session-enabled trillium host will
have a cookie attached, whether or not there is anything stored in
that client’s session yet.</p>
<h2 id="stores" class="section-header"><a href="#stores">Stores</a></h2>
<p>Although this crate provides two bundled session stores, it is highly
recommended that trillium applications use an
external-datastore-backed session storage. For a list of currently
available session stores, see <a href="https://github.com/http-rs/async-session">the documentation for
async-session</a>.</p>
<h2 id="security" class="section-header"><a href="#security">Security</a></h2>
<p>Although each session store may have different security implications,
the general approach of trillium’s session system is as follows: On
each request, trillium checks the cookie configurable as <code>cookie_name</code>
on the handler.</p>
<h3 id="if-no-cookie-is-found" class="section-header"><a href="#if-no-cookie-is-found">If no cookie is found:</a></h3>
<p>A cryptographically random cookie value is generated. A cookie is set
on the outbound response and signed with an HKDF key derived from the
<code>secret</code> provided on creation of the SessionHandler.  The configurable
session store uses a SHA256 digest of the cookie value and stores the
session along with a potential expiry.</p>
<h3 id="if-a-cookie-is-found" class="section-header"><a href="#if-a-cookie-is-found">If a cookie is found:</a></h3>
<p>The hkdf derived signing key is used to verify the cookie value’s
signature. If it verifies, it is then passed to the session store to
retrieve a Session. For most session stores, this will involve taking
a SHA256 digest of the cookie value and retrieving a serialized
Session from an external datastore based on that digest.</p>
<h3 id="expiry" class="section-header"><a href="#expiry">Expiry</a></h3>
<p>In addition to setting an expiry on the session cookie, trillium
sessions include the same expiry in their serialization format. If an
adversary were able to tamper with the expiry of a cookie, trillium
sessions would still check the expiry on the contained session before
using it</p>
<h3 id="if-anything-goes-wrong-with-the-above-process" class="section-header"><a href="#if-anything-goes-wrong-with-the-above-process">If anything goes wrong with the above process</a></h3>
<p>If there are any failures in the above session retrieval process, a
new empty session is generated for the request, which proceeds through
the application as normal.</p>
<h2 id="staleexpired-session-cleanup" class="section-header"><a href="#staleexpired-session-cleanup">Stale/expired session cleanup</a></h2>
<p>Any session store other than the cookie store will accumulate stale
sessions.  Although the trillium session handler ensures that they
will not be used as valid sessions, For most session stores, it is the
trillium application’s responsibility to call cleanup on the session
store if it requires it</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="kw">use</span> <span class="ident">trillium::Conn</span>;
<span class="kw">use</span> <span class="ident">trillium_cookies</span>::{<span class="ident">CookiesHandler</span>, <span class="ident">cookie::Cookie</span>};
<span class="kw">use</span> <span class="ident">trillium_sessions</span>::{<span class="ident">MemoryStore</span>, <span class="ident">SessionConnExt</span>, <span class="ident">SessionHandler</span>};
<span class="kw">let</span> <span class="ident">session_secret</span> <span class="op">=</span> <span class="ident">std::env::var</span>(<span class="string">&quot;TRILLIUM_SESSION_SECRET&quot;</span>).<span class="ident">unwrap</span>();

<span class="kw">let</span> <span class="ident">handler</span> <span class="op">=</span> (
    <span class="ident">CookiesHandler::new</span>(),
    <span class="ident">SessionHandler::new</span>(<span class="ident">MemoryStore::new</span>(), <span class="ident">session_secret</span>.<span class="ident">as_bytes</span>()),
    <span class="op">|</span><span class="ident">conn</span>: <span class="ident">Conn</span><span class="op">|</span> <span class="kw">async</span> <span class="kw">move</span> {
        <span class="kw">let</span> <span class="ident">count</span>: <span class="ident">usize</span> <span class="op">=</span> <span class="ident">conn</span>.<span class="ident">session</span>().<span class="ident">get</span>(<span class="string">&quot;count&quot;</span>).<span class="ident">unwrap_or_default</span>();
        <span class="ident">conn</span>.<span class="ident">with_session</span>(<span class="string">&quot;count&quot;</span>, <span class="ident">count</span> <span class="op">+</span> <span class="number">1</span>)
            .<span class="ident">ok</span>(<span class="macro">format!</span>(<span class="string">&quot;count: {}&quot;</span>, <span class="ident">count</span>))
    },
);

<span class="kw">use</span> <span class="ident">trillium_testing::prelude</span>::<span class="kw-2">*</span>;
<span class="kw">let</span> <span class="kw-2">mut</span> <span class="ident">conn</span> <span class="op">=</span> <span class="ident">get</span>(<span class="string">&quot;/&quot;</span>).<span class="ident">on</span>(<span class="kw-2">&amp;</span><span class="ident">handler</span>);
<span class="macro">assert_ok!</span>(<span class="kw-2">&amp;</span><span class="kw-2">mut</span> <span class="ident">conn</span>, <span class="string">&quot;count: 0&quot;</span>);

<span class="kw">let</span> <span class="ident">set_cookie_header</span> <span class="op">=</span> <span class="ident">conn</span>.<span class="ident">headers_mut</span>().<span class="ident">get_str</span>(<span class="string">&quot;set-cookie&quot;</span>).<span class="ident">unwrap</span>();
<span class="kw">let</span> <span class="ident">cookie</span> <span class="op">=</span> <span class="ident">Cookie::parse_encoded</span>(<span class="ident">set_cookie_header</span>).<span class="ident">unwrap</span>();

<span class="kw">let</span> <span class="ident">make_request</span> <span class="op">=</span> <span class="op">|</span><span class="op">|</span> <span class="ident">get</span>(<span class="string">&quot;/&quot;</span>)
    .<span class="ident">with_request_header</span>(<span class="string">&quot;cookie&quot;</span>, <span class="macro">format!</span>(<span class="string">&quot;{}={}&quot;</span>, <span class="ident">cookie</span>.<span class="ident">name</span>(), <span class="ident">cookie</span>.<span class="ident">value</span>()))
    .<span class="ident">on</span>(<span class="kw-2">&amp;</span><span class="ident">handler</span>);

<span class="macro">assert_ok!</span>(<span class="ident">make_request</span>(), <span class="string">&quot;count: 1&quot;</span>);
<span class="macro">assert_ok!</span>(<span class="ident">make_request</span>(), <span class="string">&quot;count: 2&quot;</span>);
<span class="macro">assert_ok!</span>(<span class="ident">make_request</span>(), <span class="string">&quot;count: 3&quot;</span>);
<span class="macro">assert_ok!</span>(<span class="ident">make_request</span>(), <span class="string">&quot;count: 4&quot;</span>);</code></pre></div>
</div></details><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2>
<div class="item-table"><div class="item-left module-item"><a class="struct" href="struct.CookieStore.html" title="trillium_sessions::CookieStore struct">CookieStore</a></div><div class="item-right docblock-short"><p>A session store that serializes the entire session into a Cookie.</p>
</div><div class="item-left module-item"><a class="struct" href="struct.MemoryStore.html" title="trillium_sessions::MemoryStore struct">MemoryStore</a></div><div class="item-right docblock-short"><p>in-memory session store</p>
</div><div class="item-left module-item"><a class="struct" href="struct.Session.html" title="trillium_sessions::Session struct">Session</a></div><div class="item-right docblock-short"><p>The main session type.</p>
</div><div class="item-left module-item"><a class="struct" href="struct.SessionHandler.html" title="trillium_sessions::SessionHandler struct">SessionHandler</a></div><div class="item-right docblock-short"><p>Handler to enable sessions.</p>
</div></div><h2 id="traits" class="section-header"><a href="#traits">Traits</a></h2>
<div class="item-table"><div class="item-left module-item"><a class="trait" href="trait.SessionConnExt.html" title="trillium_sessions::SessionConnExt trait">SessionConnExt</a></div><div class="item-right docblock-short"><p>extension trait to add session support to <a href="../trillium/conn/struct.Conn.html" title="Conn"><code>Conn</code></a></p>
</div></div></section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../" data-current-crate="trillium_sessions" data-search-index-js="../search-index.js" data-search-js="../search.js"></div>
    <script src="../main.js"></script>
</body></html>