<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Core Concepts - trillium</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="welcome.html"><strong aria-hidden="true">1.</strong> Welcome</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="who.html"><strong aria-hidden="true">1.1.</strong> Who is behind this</a></li><li class="chapter-item expanded "><a href="conventions.html"><strong aria-hidden="true">1.2.</strong> About this document</a></li></ol></li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">2.</strong> Architectural Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="core_concepts.html" class="active"><strong aria-hidden="true">2.1.</strong> Core Concepts</a></li></ol></li><li class="chapter-item expanded "><a href="handlers.html"><strong aria-hidden="true">3.</strong> A tour of handler libraries</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="handlers/router.html"><strong aria-hidden="true">3.1.</strong> Router</a></li><li class="chapter-item expanded "><a href="handlers/templates.html"><strong aria-hidden="true">3.2.</strong> Template Engines</a></li><li class="chapter-item expanded "><a href="handlers/logger.html"><strong aria-hidden="true">3.3.</strong> Logger</a></li><li class="chapter-item expanded "><a href="handlers/cookies.html"><strong aria-hidden="true">3.4.</strong> Cookies</a></li><li class="chapter-item expanded "><a href="handlers/sessions.html"><strong aria-hidden="true">3.5.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="handlers/proxy.html"><strong aria-hidden="true">3.6.</strong> Proxy</a></li><li class="chapter-item expanded "><a href="handlers/static.html"><strong aria-hidden="true">3.7.</strong> Static Files</a></li><li class="chapter-item expanded "><a href="handlers/websockets.html"><strong aria-hidden="true">3.8.</strong> Websockets</a></li></ol></li><li class="chapter-item expanded "><a href="contributing.html"><strong aria-hidden="true">4.</strong> Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">trillium</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="two-core-concepts-conn-and-handlers"><a class="header" href="#two-core-concepts-conn-and-handlers">Two core concepts: Conn and Handlers</a></h1>
<p>The two most important concepts in trillium are the <code>Conn</code> type and the
<code>Handler</code> trait. Each <code>Conn</code> represents a single http request/response
pair.</p>
<h2 id="handlers"><a class="header" href="#handlers">Handlers</a></h2>
<p>The simplest form of a handler is any async function that takes a
<code>Conn</code> and returns that <code>Conn</code>. This example sets a <code>200 Ok</code> status
and sets a string body.</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use trillium::Conn;
async fn hello_world(conn: Conn) -&gt; Conn {
    conn.ok(&quot;hello world!&quot;)
}
<span class="boring">}
</span></code></pre></pre>
<p>With no further modification, we can drop this handler into a trillium
server and it will respond to http requests for us. We're using the
<a href="https://github.com/smol-rs/smol"><code>smol</code></a>-runtime based server adapter
here.</p>
<pre><pre class="playground"><code class="language-rust edition2018">pub fn main() {
    trillium_smol_server::run(hello_world);
}
</code></pre></pre>
<p>We can also define this as a closure:</p>
<pre><pre class="playground"><code class="language-rust edition2018">pub fn main() {
    trillium_smol_server::run(|conn: trillium::Conn| async move {
        conn.ok(&quot;hello world&quot;)
    });
}
</code></pre></pre>
<p>This handler will respond to any request at localhost:8080, regardless of
path, and it will always send a <code>200 Ok</code> http status with the
specified body of <code>&quot;hello world&quot;</code>.</p>
<h2 id="conn"><a class="header" href="#conn">Conn</a></h2>
<p>Before we explore the concept of a handler further, let's take a quick
aside for <code>Conn</code>. As mentioned above, <code>Conn</code> represents both the
request and response, as well as any data your application associates
with that request-response cycle.</p>
<blockquote>
<p>üßë‚Äçüéì Advanced aside: Although the naming of Conn is directly
borrowed from Elixir's <a href="https://github.com/elixir-plug/plug"><code>plug</code></a>
and therefore also <a href="https://www.phoenixframework.org/"><code>Phoenix</code></a>,
it does in fact also own (in the rust sense) the singular
<code>TcpStream</code> that represents the connection with the http client, and
dropping a <code>Conn</code> will also disconnect the client as a result.</p>
</blockquote>
<p>The <a href="https://docs.trillium.rs/trillium/struct.conn">rustdocs for Conn</a>
contain the full details for all of the things you can do with a conn.</p>
<h3 id="returning-conn"><a class="header" href="#returning-conn">Returning Conn</a></h3>
<p>In general, because you'll be returning <code>Conn</code> from handlers, it
supports a chainable (fluent) interface for setting properties, like:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>conn.with_status(202)
    .with_header((&quot;content-type&quot;, &quot;application/something-custom&quot;))
    .with_body(&quot;this is my custom body&quot;)
<span class="boring">}
</span></code></pre></pre>
<h3 id="accessing-http-request-properties"><a class="header" href="#accessing-http-request-properties">Accessing http request properties</a></h3>
<p>Conn also contains read-only properties like request headers, request
path, and request method, each of which have getter associated
functions.</p>
<h3 id="default-response"><a class="header" href="#default-response">Default Response</a></h3>
<p>The default response for a Conn is a 404 with no response body, so it
is always valid to return the Conn from a handler unmodified (<code>|conn: Conn| async move { conn }</code> is the simplest valid handler).</p>
<h3 id="state"><a class="header" href="#state">State</a></h3>
<p>In addition to holding the request properties and accumulating the
response your application is going to send, a Conn also serves as a
data structure for any information your application needs to associate
with that request. This is especially valuable for communicating
between handlers, and most core handlers are implemented using conn
state. One important caveat to is that each Conn can only contain
exactly one of each type, so it is highly recommended that you only
store types that you define in state.</p>
<blockquote>
<p>üåä Comparison with Tide: Tide has three different types of state:
Server state, request state, and response state. In Trillium, server
state is achieved using the <a href="https://docs.trillium.rs/trillium/struct.state"><code>trillium::State</code></a> handler, which holds any
type that is Clone and puts a clone of it into the state of each
Conn that passes through the handler.</p>
</blockquote>
<h3 id="extending-conn"><a class="header" href="#extending-conn">Extending Conn</a></h3>
<p>It is a very common pattern in trillium for libraries to extend Conn in
order to provide additional functionality.  The Conn interface does
not provide support for sessions, cookies, route params, or many other
building blocks that other frameworks build into the core
types. Instead, to use sessions as an example, <code>trillium_sessions</code>
provides a <code>SessionConnExt</code> trait which provides associated functions
for Conn that offer session support. In general, handlers that put
data into conn state also will provide convenience functions for
accessing that state, and will export a <code>[Something]ConnExt</code> trait.</p>
<h2 id="servers"><a class="header" href="#servers">Servers</a></h2>
<p>Let's talk a little more about that <code>trillium_smol_server::run</code> line we've
been writing. Trillium itself is built on <code>futures</code> (<code>futures-lite</code>,
specifically). In order to run it, it needs an adapter to an async
runtime. These adapters are called servers, and there are four of them
currently:</p>
<ul>
<li><code>trillium_async_std_server</code></li>
<li><code>trillium_smol_server</code></li>
<li><code>trillium_tokio_server</code></li>
<li><code>trillium_aws_lambda_server</code></li>
</ul>
<p>Although we've been using the smol server in these docs thus far, you
should use whichever runtime you prefer. If you expect to have a
dependency on async-std or tokio anyway, you might as well use the
server for that runtime.</p>
<p>To run trillium on a different host or port, either provide a <code>HOST</code> and/or <code>PORT</code> environment variables, or compile the specific values into the server as follows:</p>
<pre><pre class="playground"><code class="language-rust edition2018">pub fn main() {
    trillium_smol_server::config()
        .with_port(1337)
        .with_host(&quot;127.0.0.1&quot;)
        .run(|conn: trillium::Conn| async move { conn.ok(&quot;hello world&quot;) })
}
</code></pre></pre>
<h3 id="tls--https"><a class="header" href="#tls--https">TLS / HTTPS</a></h3>
<p>With the exception of aws lambda, which provides its own tls
termination at the load balancer, each of the above servers can be
combined with either rustls or native-tls.</p>
<p>Rustls:</p>
<pre><pre class="playground"><code class="language-rust edition2018">use trillium::Conn;
use trillium_rustls::RustTls;

const KEY: &amp;[u8] = include_bytes!(&quot;./key.pem&quot;);
const CERT: &amp;[u8] = include_bytes!(&quot;./cert.pem&quot;);

pub fn main() {
    env_logger::init();
    trillium_smol_server::config()
        .with_acceptor(RustTls::from_pkcs8(CERT, KEY))
        .run(|conn: Conn| async move { conn.ok(&quot;ok&quot;) });
}
</code></pre></pre>
<p>Native tls:</p>
<pre><pre class="playground"><code class="language-rust edition2018">use trillium::Conn;
use trillium_native_tls::NativeTls;

pub fn main() {
    env_logger::init();
    trillium_smol_server::config()
        .with_acceptor(NativeTls::from_pkcs12(
            include_bytes!(&quot;./identity.p12&quot;),
            &quot;changeit&quot;,
        ))
        .run(|conn: Conn| async move { conn.ok(&quot;ok&quot;) });
}
</code></pre></pre>
<h2 id="tuples-and-sequences"><a class="header" href="#tuples-and-sequences">Tuples and Sequences</a></h2>
<p>Earlier, we discussed that we can use state to send data between
handlers and that handlers can always pass along the conn
unchanged. In order to use this, we need to introduce the notion of
Sequences. A Sequence is a <code>Vec</code> of boxed dyn handlers, each of which
is run on the connection until one of the handlers halts the conn. A
tuple handler is the generic stack-allocated fixed-length
equivalent. If you're unsure which to use, start with a tuple.</p>
<blockquote>
<p>üîå Readers familiar with elixir plug will recognize this notion as
identical to pipelines, and that the term halt <a href="https://hexdocs.pm/plug/Plug.Conn.html#halt/1">is <del>stolen from</del>
inspired by plug</a></p>
</blockquote>
<h3 id="tuple-handlers"><a class="header" href="#tuple-handlers">Tuple handlers</a></h3>
<p>For sequences of up to 15 handlers with types that are known at
compile-time, tuples can and should be used. This avoids
heap-allocating handlers.</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>env_logger::init();
run((
    trillium_logger::DevLogger,
    |conn: Conn| async move { conn.ok(&quot;sequence!&quot;) }
));
<span class="boring">}
</span></code></pre></pre>
<p>This snippet adds a http logger to our application, so that if we
execute our application with <code>RUST_LOG=info cargo run</code> and make a
request to localhost:8000, we'll see something like <code>GET / 200 390.706¬µs 9bytes</code> on stdout.</p>
<h3 id="building-a-sequence"><a class="header" href="#building-a-sequence">Building a Sequence</a></h3>
<p>For more information on sequences, see
<a href="https://docs.trillium.rs/trillium/struct.sequence">trillium::Sequence</a></p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>env_logger::init();
run(trillium::Sequence::new()
    .and(trillium_logger::DevLogger)
    .and(|conn: Conn| async move { conn.ok(&quot;sequence!&quot;) }));
<span class="boring">}
</span></code></pre></pre>
<h3 id="macros-if-you-want-them"><a class="header" href="#macros-if-you-want-them">Macros, if you want them</a></h3>
<p>Because sequences are quite common in trillium, we also have a macro that
makes them even easier to build. Instead of writing
<code>Sequence::new().and(a).and(b).and(c)</code> we can write
<code>trillium::sequence![a, b, c]</code>, which makes our above example:</p>
<pre><pre class="playground"><code class="language-rust edition2018">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>env_logger::init();
run(trillium::sequence![
    trillium_logger::DevLogger,
    |conn: Conn| async move { conn.ok(&quot;sequence!&quot;) }
]);
<span class="boring">}
</span></code></pre></pre>
<p>Sequence is itself a handler, and as a result can be used in any place
another handler could be used.  If you need to, you can nest sequences
inside of each other.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="architecture.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="handlers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="architecture.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="handlers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
